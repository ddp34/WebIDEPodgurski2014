{% extends 'base.html' %}
{% block body_block %}


      <div class="editorpane">

	<div class="leftpane">
	  <p>File Browser</p>
	  <div class="filebrowserview">
	    <ul class="filelist">
	      {% for filename in files %}
	      <li class="filenode"><a href="#" onclick="openFile('{{ filename }}')">{{ filename }}</a></li>
	      {% endfor %}
	    </ul>
	  </div>
	</div>

	<div class="centerpane">

	  <div class="filename">
	    README.md
          <button type="button" onclick="sendCode()" style="float:center;">Run</button>
	  </div>
	  <textarea id="fileview" class="filecontentsview" spellcheck="false">{{ filetext }}</textarea>
	</div>

	<div class="rightpane">
	  <p>Chat</p>
	  <div class="chatview">
	    <div class="chatmessagedisplay">
	      Chat Messages will show up here.
	    </div>
	    <div class="entrywindow" contenteditable="true">
	      Enter Chat Text Here...
	    </div>
	  </div>
	</div>

    <div class="bottompane">
        <textarea id="output" class="outputview" spellcheck="false" >{{ outputtext }}</textarea>
    </div>

      </div>
<script>
//global variables

//the sync polling interval (in milliseconds). the shorter, the more responsive.
window['pollinginterval'] = 500

//polling ID, used to stop polling on demand
window['pollingid'] = 0

//filename of the current file open
window['curfilename'] = "README.md"

//the client shadow for differential synchronization
window['shadow'] = "{% filter escapejs %} {{ clishadow }} {% endfilter %}"

//the caret position for this client, which we want to preserve
window['caretpos'] = 0

//functions

function setSelectionRange(input, selectionStart, selectionEnd) {
  if (input.setSelectionRange) {
    input.focus();
    input.setSelectionRange(selectionStart, selectionEnd);
  }
  else if (input.createTextRange) {
    var range = input.createTextRange();
    range.collapse(true);
    range.moveEnd('character', selectionEnd);
    range.moveStart('character', selectionStart);
    range.select();
  }
}

function setCaretToPos (input, pos) {
  setSelectionRange(input, pos, pos);
}

//sets the caret position
function setCaret(pos) {
var range = document.createRange();
range.setStart($("#fileview")[0], pos);
range.collapse(true);
window.getSelection().removeAllRanges();
window.getSelection().addRange(range);
}

//pings the server for a sync update. The server does the computations and returns a text and updated shadow
//to the client.
function pingServer() {

//we need to keep the caret position
window['caretpos'] = $("#fileview")[0].selectionStart;

//send POST request with ajax

$.ajax ({
url: '/web_ide/editor/',
data: {clienttext: $("#fileview").val(), clientshadow: window['shadow'], csrfmiddlewaretoken:'{{csrf_token}}', filename: window['curfilename'], posttype: 'syncrequest'},
dataType: 'json',
type: "POST",
success: function(response) {
//update text in editor
$("#fileview").val(response.clienttext);
//restore the caret position
//setCaret(1);
setCaretToPos(document.getElementById("fileview"), window['caretpos']);
//update client shadow
window['shadow'] = response.clientshadow;
}
})

}

//sets the sync function to run at the polling interval.
//originally responded to a button, but now will be called upon page loading.
function beginSync() {
window['pollingid'] = setInterval(pingServer, window['pollinginterval']);
}

//stops sync function until beginSync() is called again.
function stopSync() {
clearInterval(window['pollingid']);
}

//sleep function
function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}

//click function for filebrowser.
//opens the new file in code editor window
function openFile(filename) {

//alert(filename);

stopSync();
//wait for old server responses
sleep(1000);
window['curfilename'] = filename;
$(".filename").text(filename);
//get new file data from server
$.ajax({

url: '/web_ide/editor/',
data: {filename: filename, posttype: 'openfile', csrfmiddlewaretoken: '{{ csrf_token }}'},
dataType: 'json',
type: "POST",
success: function(response) {
//update client text and shadow
$("#fileview").val(response.clienttext);
window['shadow'] = response.clienttext;
//set caret position to 0
window['caretpos'] = 0;
}

});

//restart sync
beginSync();

}

function sendCode() {
var code = $(".filecontentsview").val();
//ajax
$.ajax({

url: '/web_ide/editor/',
data: { posttype: 'sendcode', src: code, csrfmiddlewaretoken: '{{ csrf_token }}'},
dataType: 'text',
type: "POST",
success: function(response) {
// display program output
$(".outputview").val(response.outputtext);
}

});
} //end sendCode

}

//start synchronization immediately when document is ready
$(document).ready(beginSync);
</script>
{% endblock %}
